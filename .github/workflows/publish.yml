name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 0.2.0). Must match pyproject.toml."
        required: true
        type: string

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check version matches pyproject.toml
        run: |
          TOML_VERSION=$(python3 -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          if [ "$TOML_VERSION" != "${{ inputs.version }}" ]; then
            echo "::error::Input version '${{ inputs.version }}' does not match pyproject.toml version '$TOML_VERSION'"
            exit 1
          fi

      - name: Check tag does not already exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

  lint:
    name: Lint & Format
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group dev

      - name: Ruff format check
        run: uv run ruff format --check src/ tests/

      - name: Ruff lint
        run: uv run ruff check src/ tests/

  typecheck:
    name: Type Check
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group dev

      - name: mypy
        run: uv run mypy src/

  test:
    name: Tests
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group dev

      - name: pytest
        run: uv run pytest tests/unit tests/integration -v

  publish:
    name: Publish to PyPI
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create git tag and GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --generate-notes \
            dist/*
